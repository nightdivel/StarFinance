# Star Finance — Документация

## Обзор
Star Finance — система управления финансами и складом (витрина, заявки, транзакции). Ниже описан актуальный бизнес-флоу «финансовых заявок» и «заявок на покупку», права доступа и изменения, внесённые в логику подтверждений и балансов.

## Термины
- Заявка на покупку (vitirina): создание резерва товара со склада. Подтверждает продавец (владелец товара) или администратор.
- Финансовая заявка: создаётся автоматически для исходящих транзакций, чтобы получатель подтвердил зачисление. Подтверждает только получатель или администратор.

## Роли и права
- Администратор: имеет расширенные права (users:write, finance:write, requests:write) и может подтверждать/отменять в обоих процессах.
- Продавец (владелец товара): может подтверждать «заявки на покупку» по своему товару.
- Покупатель (инициатор заявки на покупку): может отменить свою «заявку на покупку» до подтверждения.
- Получатель (финансовая заявка): может подтверждать/отменять финансовую заявку на своё имя.

## Финансовые заявки (исходящие транзакции)
- При создании исходящей транзакции (`type = outcome`) формируется связанная запись в `finance_requests` со статусом `В обработке`.
- До подтверждения получателем баланс НЕ меняется.
- Подтверждение:
  - Endpoint: `PUT /api/finance-requests/:id/confirm`
  - Кто может: получатель `to_user` или администратор (право `finance:write`)
  - Эффект: статус заявки -> `Выполнено`, в транзакции `meta.status = "Выполнено"`, баланс учитывает сумму.
- Отмена:
  - Endpoint: `PUT /api/finance-requests/:id/cancel`
  - Кто может: получатель `to_user` или администратор (право `finance:write`)
  - Эффект: транзакция удаляется (`DELETE FROM transactions ...`), запись `finance_requests` удаляется каскадно (ON DELETE CASCADE). На фронт уходят socket-события `finance_requests:changed { action: 'deleted' }` и `transactions:changed { action: 'deleted' }`.
- Список связанных заявок текущего пользователя:
  - Endpoint: `GET /api/finance-requests/related`

### Баланс
- В разделе «Финансы» баланс считается по транзакциям, где текущий пользователь — отправитель/получатель.
- Исходящие транзакции, которые требуют подтверждения (имеют `meta.financeRequestId`) учитываются ТОЛЬКО если `meta.status === 'Выполнено'`.
- Это исключает преждевременное списание/зачисление до подтверждения.

## Заявки на покупку (витрина)
- Создание заявки:
  - Endpoint: `POST /api/requests`
  - Эффект: резерв на складе (уменьшение количества), заявка со статусом `В обработке`.
- Подтверждение продавцом или админом:
  - Endpoint: `PUT /api/requests/:id/confirm`
  - Эффект: создаётся финансовая транзакция (доход продавца от покупателя), заявка -> `Выполнено`.
- Отмена покупателем или админом:
  - Endpoint: `PUT /api/requests/:id/cancel`
  - Эффект: возврат зарезервированного количества на склад, заявка -> `Отменена`.
- Списки:
  - Мои заявки: `GET /api/my/requests`
  - Все заявки (админ): `GET /api/requests`

## Поведение фронтенда
- Requests (страница Заявки):
  - «Заявки на покупку»: кнопка «Подтвердить» активна у продавца (владельца товара) и админа, «Отменить» — у покупателя и админа, пока статус в ожидании.
  - «Финансовые заявки»: кнопки «Подтвердить/Отменить» активны ТОЛЬКО у получателя (сравнение по username без регистра), пока статус `В обработке`.
- Finance (страница Финансы):
  - Балансы не учитывают исходящие транзакции, требующие подтверждения, пока они не `Выполнено`.

## Реалтайм (websocket события)
- `transactions:changed` — created/updated/deleted
- `finance_requests:changed` — created/updated/deleted
- `requests:changed` — created/updated

## Тестовый сценарий (финансовая заявка)
1. Пользователь A создаёт исходящую транзакцию на пользователя B.
2. У пользователя B в «Финансовых заявках» активны «Подтвердить/Отменить».
3. До подтверждения баланс A/B неизменен.
4. B подтверждает — статус становится `Выполнено`, баланс меняется.
5. B отменяет — транзакция удаляется, заявка исчезает, баланс неизменен.

## Запуск через Docker
- Сборка: `npm run docker:build`
- Подъём: `npm run docker:up`
- Приложение: http://localhost/
- API: http://localhost/api/

## Примечания по данным пользователя (frontend)
- Текущий пользователь читается через `authService.getCurrentUser()`. Для проверок на получателя используется `username` без учёта регистра.

## Схемы данных (упрощённо)
- `transactions(id, type, amount, currency, from_user, to_user, item_id, meta)`
- `finance_requests(id, transaction_id, from_user, to_user, status, created_at, updated_at)`
  - `transaction_id` → `transactions.id` (ON DELETE CASCADE)

## Версии и изменения
- [2025-10-25]
  - Балансы: исключены непотверждённые исходящие транзакции из расчёта до `Выполнено`.
  - Финансовые заявки: у получателя активированы кнопки по username (регистронезависимо).
  - Отмена финансовой заявки удаляет связанную транзакцию; на фронт отправляются события `deleted`.
