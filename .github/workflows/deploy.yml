# .github/workflows/deploy.yml
name: Deploy to 77.37.200.234

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy via SSH (password)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Add server to known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H 77.37.200.234 >> ~/.ssh/known_hosts

    - name: Deploy on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 77.37.200.234
        username: ${{ secrets.LOGIN }}
        password: ${{ secrets.PASS }}
        port: 22
        script: |
          set -e
          PROJECT_DIR="$HOME/StarFinance"
          REPO_URL=https://github.com/nightdivel/StarFinance.git

          echo "[INFO] Preparing project dir: ${PROJECT_DIR}"
          if [ ! -d "${PROJECT_DIR}" ]; then
            mkdir -p "${PROJECT_DIR}"
          fi

          if [ ! -d "${PROJECT_DIR}/.git" ]; then
            echo "[INFO] Cloning repository..."
            git clone "${REPO_URL}" "${PROJECT_DIR}"
          fi

          cd "${PROJECT_DIR}"
          BRANCH=${GIT_BRANCH:-main}
          echo "[INFO] Updating branch: ${BRANCH}"
          git fetch origin
          git checkout ${BRANCH}
          git pull --rebase origin ${BRANCH}

          echo "[INFO] Docker compose build & restart"
          docker compose version
          docker compose down --remove-orphans || true
          docker compose build --no-cache
          docker compose up -d --force-recreate

          echo "[INFO] Deleting dangling images"
          docker image prune -f || true