# Star Finance — Функциональная спецификация

## 1. Назначение и цели
- Обеспечить учёт товарных позиций на складе, публикацию на витрину и оформление покупок.
- Предоставить роли и права доступа для безопасного управления данными.
- Вести финансовые транзакции, связанные с подтверждёнными заявками.
- Поддерживать справочники (типы, статусы, локации, валюты/курсы) для нормализации данных.
- Обеспечить персонализацию (тема, макеты интерфейса).

## 2. Область действия (Scope)
Входит:
- Аутентификация (JWT) и авторизация по типам аккаунтов и ресурсам.
- Модули: Пользователи/Типы, Склад, Витрина, Заявки на покупку, Транзакции, Справочники, Пользовательские настройки, Discord настройки (scopes/mappings), системный фон страницы входа.
- API для интеграции с внешними клиентами (Frontend/боты/инструменты).
Не входит:
- Подробные UI-гайды и дизайн-макеты.
- Платёжные шлюзы и реальные финоперации за пределами внутреннего модуля транзакций.

## 3. Термины и определения
- Складская позиция (Warehouse Item): позиция учёта с количеством, типом и атрибутами.
- Витринная позиция (Showcase Item): публикация складской позиции для отображения и продажи.
- Заявка (Purchase Request): запрос на покупку, резервирует количество.
- Транзакция (Transaction): запись финансовой операции по подтверждённой заявке.
- Тип аккаунта (Account Type): роль пользователя (Администратор/Пользователь/Гость/...).
- Ресурс прав: логическая область доступа (`settings`, `users`, `warehouse`, `showcase`, `requests`, `transactions`, `directories`).

## 4. Роли и разрешения
- Администратор: `write` ко всем основным ресурсам.
- Пользователь: как минимум `read` к складу/витрине, `read` к заявкам; может создавать заявки и управлять своими данными.
- Гость: ограниченный `read` (минимум) — по политике.
- Разрешения настраиваются через `account_types` и `account_type_permissions`.

## 5. Высокоуровневые сценарии (Use Cases)
- UC-1. Авторизация пользователя
  - OAuth Discord или локальный вход → получение JWT → `GET /auth/profile` для загрузки профиля и прав.
- UC-2. Управление темой и персональными макетами
  - Пользователь сохраняет тему (`PUT /api/user/theme`) и макеты страниц (`PUT /api/user/layouts/:page`).
- UC-3. Управление складом (Админ/менеджер)
  - Создание/редактирование/удаление позиций; изменение количества (в т.ч. владельцем позиции).
- UC-4. Публикация на витрину
  - Создание витринных карточек из складских позиций, обновление статусов и цен.
- UC-5. Оформление заявки на покупку
  - Пользователь создаёт заявку → количество резервируется, покупка собственной позиции запрещена.
- UC-6. Подтверждение/отмена заявки
  - Подтверждение (админ/владелец позиции) → создаётся транзакция.
  - Отмена (админ/покупатель) → резерв возвращается.
- UC-7. Финансовые операции
  - CRUD транзакций (связь с пользователями и позициями, метаданные).
- UC-8. Управление справочниками
  - Поддержка типовых словарей (типы продуктов, статусы витрины, локации, валюты, курсы, наименования и т.д.).
- UC-9. Управление пользователями/типами аккаунтов
  - Создание пользователей, смена пароля, CRUD типов аккаунтов и их прав.
- UC-10. Системные настройки
  - Фон страницы входа (загрузка/удаление), Discord scopes и mappings, валюты/курсы.

## 6. Функциональные требования по модулям

### 6.1 Аутентификация и авторизация
- Система должна проверять JWT на всех защищённых эндпоинтах.
- Система должна определять права пользователя по типу аккаунта и ресурсу (`none|read|write`).
- При отсутствии/недействительности токена — 401/403.

### 6.2 Пользовательские настройки
- Хранить предпочтение темы (`light|dark`) и отдавать при запросе.
- Хранить и возвращать макеты интерфейса пользователя по ключу `page`.

### 6.3 Пользователи и типы аккаунтов
- Создавать/удалять пользователей, изменять пароль.
- Создавать/обновлять/удалять типы аккаунтов и их разрешения.
- Аккаунты могут быть активированы/деактивированы (`is_active`).

### 6.4 Склад
- Создавать/редактировать/удалять позиции склада.
- Изменять количество позиции, включая проверку владельца `owner_login` или права `warehouse:write`.
- Вести поля: тип, локация, валюта, отображаемые валюты, произвольные метаданные.

### 6.5 Витрина
- Создавать/редактировать/удалять витринные позиции, связанные со складом.
- Управлять статусами витринных позиций.

### 6.6 Заявки на покупку
- Создавать заявку с проверкой, что пользователь не покупает собственную позицию.
- При создании — резервировать количество (уменьшать доступное на складе, увеличивать `reserved`).
- Подтверждать/отменять заявку с соответствующими правами и возвратом резерва при отмене.
- Логировать действия по заявке в `purchase_request_logs`.

### 6.7 Транзакции
- Создавать/редактировать/удалять финансовые операции.
- Привязка к пользователям (`from_user`, `to_user`) и сущностям (например, item_id).

### 6.8 Справочники
- CRUD для словарей: типы продуктов, статусы витрины, локации склада, наименования, валюты, курсы.
- Возвращать агрегированную структуру `GET /api/directories` для инициализации клиента.

### 6.9 Системные настройки
- Загрузка/удаление фонового изображения страницы входа.
- Discord: справочник скоупов и маппинги `scope→(value)→account_type`.
- Управление валютами и курсами, включая базовую валюту и матрицу курсов.

## 7. Бизнес-правила
- Нельзя оформлять заявку на покупку собственной позиции (по `owner_login`).
- При создании заявки резервируется количество; при отмене — резерв возвращается.
- Подтверждение заявки создаёт транзакцию.
- Операции, меняющие состояние, требуют соответствующих прав `write` по ресурсу.

## 8. Нефункциональные требования (обзор)
- Безопасность: JWT-секрет должен быть криптостойким; доступ к БД ограничен; HTTPS на периметре.
- Производительность: время ответа не более 1 секунды для 95% запросов при штатной нагрузке.
- Масштабируемость: горизонтальный масштаб бэкенда за счёт stateless характерa + внешняя БД.
- Наблюдаемость: endpoint `GET /health` для health‑checks.
- Совместимость: API JSON over HTTP, CORS согласно настройкам фронтенда.

## 9. Ограничения и предположения
- Источник истины — PostgreSQL; файловое хранилище используется для публичного фона.
- Валидация входных данных на сервере базовая; детальная схема валидаторов может быть расширена.
- Реальные платёжные интеграции отсутствуют; транзакции — внутренние учётные записи.

## 10. Критерии приёмки (примерные)
- Пользователь может авторизоваться и получить профиль с корректными правами.
- Администратор может выполнять полный CRUD для Users/Types, Warehouse, Showcase, Requests, Transactions, Directories.
- Резервирование/возврат количества корректно отражается в `warehouse_items` при создании/отмене заявки.
- Подтверждение заявки создаёт связанную транзакцию.
- Тема и макеты пользователя сохраняются и возвращаются через API.
- Health‑check возвращает `{ status: 'ok' }` при доступности БД.

## 11. Диаграммы
- ERD: см. `docs/db-schema.md` (Mermaid).
- Потоки процессов (рекомендация):
  - Создание заявки → Подтверждение → Создание транзакции → Завершение.
  - Публикация на витрину → Обновление статуса/цены → Удаление публикации.

## 12. Зависимости и конфигурация
- Зависимости: Node.js, Express, PostgreSQL, JWT, Socket.IO (по необходимости), Docker/Nginx (продакшн).
- Конфигурации и переменные окружения: см. `docs/deploy.md`.

## 13. Из состава (Out of Scope)
- UI-гайд и сценарии пользовательских путей.
- Интеграция с внешними биллингами/платёжными системами.

---
Связанные документы: `docs/system-overview.md`, `docs/api-spec.md`, `docs/db-schema.md`, `docs/deploy.md`.
