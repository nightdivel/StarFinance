# BLSK Star Finance: Подробное описание бизнес-процессов и функций по разделам

Этот документ представляет собой обновленное и дополненное описание бизнес-процессов и функций системы BLSK Star Finance, структурированное по указанным разделам: Финансы, Склад, Витрина, Заявки, Пользователи, Справочники и Настройки. Информация основана на предоставленных документах, включая `sitemap.md`, и учитывает формальный тон, четкость, структурированность и профессионализм. Описание включает пользовательский интерфейс (UI), API, бизнес-процессы и технические детали для каждого раздела.

---

## 1. Финансы

### 1.1 Назначение
Модуль "Финансы" предназначен для учета и управления финансовыми операциями, связанными с подтвержденными заявками на покупку, а также для ручного создания, редактирования и просмотра транзакций. Он обеспечивает прозрачность денежных потоков, их связь с пользователями и позициями склада/витрины, а также предоставляет аналитическую панель для мониторинга.

### 1.2 Функции
- **Создание транзакций**:
  - Ручное создание через `POST /api/transactions` с параметрами: тип операции (`type`), сумма (`amount`), валюта (`currency`), отправитель (`from_user`), получатель (`to_user`), идентификатор связанной сущности (`item_id`) и метаданные (`meta`).
  - Автоматическое создание транзакции при подтверждении заявки через `PUT /api/requests/:id/confirm`.
- **Просмотр транзакций**:
  - Получение списка транзакций через `GET /api/transactions` (требуется право `transactions:read`), с возможностью фильтрации по параметрам, определенным в `backend/server.js`.
  - Отображение в UI через таблицу транзакций и панель показателей в разделе "Финансы" (`key: finance`).
- **Обновление и удаление**:
  - Редактирование через `PUT /api/transactions/:id` для обновления полей.
  - Удаление через `DELETE /api/transactions/:id` (требуется право `transactions:write`).
- **Аналитика**:
  - Панель показателей в UI предоставляет обзор финансовых операций (например, общая сумма транзакций, статистика по валютам).

### 1.3 Бизнес-процессы
1. **Создание транзакции при подтверждении заявки**:
   - Пользователь или администратор подтверждает заявку на покупку через UI или API (`PUT /api/requests/:id/confirm`).
   - Система создает запись в таблице `transactions`, включая сумму, валюту, участников и ссылку на позицию.
   - Статус заявки обновляется до "Выполнено".
2. **Ручное создание транзакции**:
   - Администратор с правом `transactions:write` создает транзакцию через UI (раздел "Финансы") или API для учета операций, таких как внутренние переводы.
   - Система валидирует данные и сохраняет запись.
3. **Анализ и мониторинг**:
   - Пользователи с правом `transactions:read` просматривают таблицу транзакций или панель показателей для анализа финансовой активности.

### 1.4 Бизнес-правила
- Транзакции связаны с пользователями (`from_user`, `to_user`) и сущностями (`item_id`) для прослеживаемости.
- Только пользователи с правом `transactions:write` могут создавать, редактировать или удалять транзакции.
- Автоматические транзакции создаются только при подтверждении заявки, обеспечивая связь с бизнес-логикой.

### 1.5 Технические детали
- **Таблица**: `transactions` (id, type, amount, currency, from_user, to_user, item_id, meta, created_at).
- **API**: `/api/transactions` (GET, POST, PUT, DELETE).
- **UI**: Раздел "Финансы" (`key: finance`) с панелью показателей и таблицей транзакций.
- **Права доступа**: `transactions:read` для просмотра, `transactions:write` для модификаций.

---

## 2. Склад

### 2.1 Назначение
Модуль "Склад" предназначен для учета товарных позиций, включая их создание, редактирование, удаление и управление количеством. Он служит основой для витрины и заявок, обеспечивая централизованное управление запасами.

### 2.2 Функции
- **Создание позиций**:
  - Через `POST /api/warehouse` с атрибутами: название (`name`), тип (`type`), количество (`quantity`), резерв (`reserved`), стоимость (`cost`), валюта (`currency`), локация (`location`), тип склада (`warehouse_type`), владелец (`owner_login`), отображаемые валюты (`display_currencies`) и метаданные (`meta`).
- **Просмотр**:
  - Получение списка позиций через `GET /api/warehouse` с фильтрацией по типу, локации и другим параметрам (требуется право `warehouse:read`).
  - Отображение в UI через список складских позиций в разделе "Склад" (`key: warehouse`).
- **Обновление**:
  - Полное обновление через `PUT /api/warehouse/:id`.
  - Частичное обновление количества через `PATCH /api/warehouse/:id/quantity` (доступно владельцу позиции или администратору с правом `warehouse:write`).
- **Удаление**:
  - Через `DELETE /api/warehouse/:id` (требуется право `warehouse:write`).
- **Операции с позициями**:
  - UI позволяет создавать, редактировать и удалять позиции через формы и таблицы.

### 2.3 Бизнес-процессы
1. **Добавление позиции**:
   - Менеджер или администратор через UI (раздел "Склад") или API создает новую позицию, указывая тип, локацию и владельца.
   - Система сохраняет запись в таблице `warehouse_items`.
2. **Корректировка количества**:
   - Владелец позиции или администратор обновляет количество через UI или `PATCH /api/warehouse/:id/quantity` после поступления или списания.
   - Система проверяет права и обновляет `quantity`.
3. **Просмотр и фильтрация**:
   - Пользователи с правом `warehouse:read` просматривают и фильтруют позиции в UI по типу, локации или владельцу.

### 2.4 Бизнес-правила
- Количество (`quantity`) не может быть отрицательным, а резерв (`reserved`) увеличивается при создании заявки.
- Изменение количества доступно только владельцу (`owner_login`) или администратору с правом `warehouse:write`.
- Позиции связаны с типами продуктов и локациями через справочники.

### 2.5 Технические детали
- **Таблица**: `warehouse_items` (id, name, type, quantity, reserved, cost, currency, location, warehouse_type, owner_login, display_currencies, meta, created_at, updated_at).
- **API**: `/api/warehouse` (GET, POST, PUT, PATCH, DELETE).
- **UI**: Раздел "Склад" (`key: warehouse`) с таблицей и формами для операций.
- **Права доступа**: `warehouse:read` для просмотра, `warehouse:write` для модификаций.

---

## 3. Витрина

### 3.1 Назначение
Модуль "Витрина" позволяет публиковать складские позиции для продажи, управлять их статусами и ценами, а также предоставляет интерфейс для оформления заявок на покупку.

### 3.2 Функции
- **Создание витринной позиции**:
  - Через `POST /api/showcase`, связывая позицию склада (`warehouse_item_id`) с указанием статуса, цены и валюты.
- **Просмотр**:
  - Получение списка позиций через `GET /api/showcase` (требуется право `showcase:read`).
  - Отображение в UI через раздел "Витрина" (`key: showcase`).
- **Обновление**:
  - Частичное обновление через `PUT /api/showcase/:id` (например, изменение статуса или цены).
- **Удаление**:
  - Удаление позиции через `DELETE /api/showcase/:id` или всех позиций для склада через `DELETE /api/showcase/by-warehouse/:warehouseItemId` (требуется право `showcase:write`).
- **Покупки**:
  - Возможность оформления заявок на покупку через UI.

### 3.3 Бизнес-процессы
1. **Публикация позиции**:
   - Менеджер через UI (раздел "Витрина") или API публикует складскую позицию, задавая цену и статус (например, "На витрине").
   - Система создает запись в таблице `showcase_items`.
2. **Обновление статуса/цены**:
   - Менеджер изменяет статус (например, на "Скрыт") или цену через UI или API.
3. **Удаление**:
   - При удалении складской позиции связанные витринные записи удаляются автоматически через каскадное удаление.

### 3.4 Бизнес-правила
- Витринная позиция связана с одной складской позицией через `warehouse_item_id`.
- Публикация и изменение доступны только пользователям с правом `showcase:write`.
- Статусы витрины определяются справочником `showcase_statuses`.

### 3.5 Технические детали
- **Таблица**: `showcase_items` (id, warehouse_item_id, status, price, currency, meta, created_at, updated_at).
- **API**: `/api/showcase` (GET, POST, PUT, DELETE), `/api/showcase/by-warehouse/:warehouseItemId`.
- **UI**: Раздел "Витрина" (`key: showcase`) с таблицей и возможностью оформления заявок.
- **Права доступа**: `showcase:read` для просмотра, `showcase:write` для модификаций.

---

## 4. Заявки

### 4.1 Назначение
Модуль "Заявки" управляет процессом оформления, обработки и логирования запросов на покупку товаров с витрины, включая резервирование запасов и создание транзакций при подтверждении.

### 4.2 Функции
- **Создание заявки**:
  - Через `POST /api/requests`, указывая `warehouse_item_id` и количество (`quantity`).
  - Система резервирует количество, увеличивая `reserved` в `warehouse_items`, и устанавливает статус "Заявка отправлена".
- **Просмотр**:
  - Собственные заявки через `GET /api/my/requests` (доступны пользователю).
  - Все заявки через `GET /api/requests` (требуется право `requests:read`, отображается в разделе "Заявки" для администраторов).
- **Подтверждение**:
  - Через `PUT /api/requests/:id/confirm`, создавая транзакцию и меняя статус на "Выполнено" (доступно владельцу позиции или администратору с правом `requests:write`).
- **Отмена**:
  - Через `PUT /api/requests/:id/cancel`, возвращая резерв и меняя статус на "Отменена" (доступно покупателю или администратору).
- **Удаление**:
  - Через `DELETE /api/requests/:id` (требуется право `requests:write`).
- **Логирование**:
  - Все действия (создание, подтверждение, отмена, удаление) фиксируются в `purchase_request_logs`.

### 4.3 Бизнес-процессы
1. **Оформление заявки**:
   - Пользователь через UI (раздел "Витрина" или "Корзина") выбирает позицию и указывает количество.
   - Система проверяет, что позиция не принадлежит пользователю (`owner_login`), резервирует количество и создает заявку.
2. **Подтверждение заявки**:
   - Владелец позиции или администратор подтверждает заявку через UI (раздел "Заявки") или API.
   - Система создает транзакцию и обновляет статус.
3. **Отмена заявки**:
   - Покупатель или администратор отменяет заявку, возвращая резерв в `warehouse_items`.
4. **Аудит**:
   - Логи действий доступны в таблице `purchase_request_logs` для анализа.

### 4.4 Бизнес-правила
- Пользователь не может оформить заявку на свою позицию (`owner_login`).
- Резерв уменьшает доступное количество (`quantity`) и возвращается при отмене.
- Подтверждение создает транзакцию, связывая ее с заявкой и позицией.
- Раздел "Заявки" в UI доступен только администраторам с правом `users:write`.

### 4.5 Технические детали
- **Таблицы**: `purchase_requests` (id, warehouse_item_id, buyer_user_id, quantity, price_per_unit, currency, status, created_at, updated_at), `purchase_request_logs` (id, request_id, action, actor_user_id, details, created_at).
- **API**: `/api/requests` (GET, POST, PUT, DELETE), `/api/my/requests`.
- **UI**: Раздел "Заявки" (`key: requests`) для администраторов, "Корзина" (`key: cart`) для пользователей.
- **Права доступа**: `requests:read` для просмотра всех заявок, `requests:write` для модификаций, ограничения для владельца/покупателя.

---

## 5. Пользователи

### 5.1 Назначение
Модуль "Пользователи" управляет учетными записями, типами аккаунтов и их разрешениями, обеспечивая ролевую модель доступа и интеграцию с Discord OAuth.

### 5.2 Функции
- **Создание пользователей**:
  - Через `POST /api/users`, указывая имя (`username`), email, пароль, тип аккаунта (`account_type`), статус активности (`is_active`) и никнейм.
- **Обновление пароля**:
  - Через `POST /api/users/:id/password` (требуется право `users:write`).
- **Удаление**:
  - Через `DELETE /api/users/:id` (требуется право `users:write`).
- **Управление типами аккаунтов**:
  - CRUD через `GET/POST/PUT/DELETE /api/account-types` и `/:name`, включая настройку разрешений для ресурсов (`settings`, `users`, `warehouse`, etc.).
- **Просмотр профиля**:
  - Через `GET /auth/profile`, возвращая данные пользователя (id, username, account_type, permissions, etc.) и отображая в UI (раздел "Профиль", `key: profile`).
- **Персонализация**:
  - Сохранение темы через `PUT /api/user/theme`.
  - Сохранение макетов страниц через `PUT /api/user/layouts/:page`.

### 5.3 Бизнес-процессы
1. **Регистрация пользователя**:
   - Администратор через UI (раздел "Пользователи") или API создает пользователя, назначая тип аккаунта и пароль.
   - Система сохраняет данные в таблице `users`.
2. **Назначение ролей**:
   - Администратор создает или обновляет тип аккаунта через UI или API, задавая права доступа.
   - Права применяются ко всем пользователям с этим типом.
3. **Аутентификация**:
   - Пользователь входит через локальный вход (`POST /auth/login`) или Discord OAuth (`GET /auth/discord`).
   - Система возвращает JWT и профиль через `GET /auth/profile`.
4. **Персонализация**:
   - Пользователь изменяет тему или макеты в разделе "Профиль" (`key: profile`).

### 5.4 Бизнес-правила
- Права доступа определяются через таблицу `account_type_permissions` (уровни: `none`, `read`, `write`).
- Пользователь может быть деактивирован (`is_active=false`) без удаления.
- Discord-атрибуты (например, роли гильдии) маппятся на типы аккаунтов через `discord_scope_mappings`.

### 5.5 Технические детали
- **Таблицы**: `users` (id, username, email, auth_type, password_hash, account_type, is_active, theme_preference, etc.), `account_types` (name), `account_type_permissions` (account_type, resource, level).
- **API**: `/api/users`, `/api/account-types`, `/auth/profile`, `/api/user/theme`, `/api/user/layouts/:page`.
- **UI**: Раздел "Пользователи" (`key: users`) для управления, "Профиль" (`key: profile`) для персональных данных.
- **Права доступа**: `users:read` для просмотра, `users:write` для модификаций.

---

## 6. Справочники

### 6.1 Назначение
Модуль "Справочники" обеспечивает нормализацию данных через управление типами продуктов, статусами витрины, локациями склада, валютами, курсами и другими справочными данными, используемыми в других модулях.

### 6.2 Функции
- **Управление справочниками**:
  - CRUD для таблиц: `product_types`, `showcase_statuses`, `warehouse_locations`, `product_names`, `warehouse_types`, `currencies`.
  - Единый эндпоинт `GET /api/directories` для загрузки всех справочников в UI (раздел "Справочники", `key: directories`).
- **Управление курсами валют**:
  - Добавление валют через `POST /api/system/currencies`.
  - Обновление курсов через `PUT /api/system/currencies/rates`.
  - Просмотр валют и курсов через `GET /api/system/currencies` и `GET /api/system/currencies/rates`.

### 6.3 Бизнес-процессы
1. **Инициализация справочников**:
   - При загрузке приложения фронтенд запрашивает справочники через `GET /api/directories` для заполнения выпадающих списков и форм.
   - Администратор добавляет или обновляет записи через UI или API.
2. **Управление валютами**:
   - Администратор задает базовую валюту и обновляет курсы для пересчета цен в UI или API.

### 6.4 Бизнес-правила
- Справочники используются для валидации данных в модулях "Склад", "Витрина" и "Заявки".
- Курсы валют хранятся относительно базовой валюты и обновляются администратором с правом `settings:write`.

### 6.5 Технические детали
- **Таблицы**: `product_types`, `showcase_statuses`, `warehouse_locations`, `product_names`, `warehouse_types`, `currencies`, `currency_rates`.
- **API**: `/api/directories`, `/api/system/currencies`, `/api/system/currencies/rates`.
- **UI**: Раздел "Справочники" (`key: directories`) для управления.
- **Права доступа**: `directories:read` для просмотра, `settings:write` для модификаций валют.

---

## 7. Настройки

### 7.1 Назначение
Модуль "Настройки" управляет системными параметрами, включая фоновое изображение страницы входа, интеграцию с Discord OAuth, валюты, а также пользовательские предпочтения, такие как тема и макеты страниц.

### 7.2 Функции
- **Фон страницы входа**:
  - Загрузка через `PUT /api/system/auth/background` (base64-изображение, максимум 25 МБ).
  - Просмотр метаданных через `GET /public/auth/background`.
  - Получение файла через `GET /public/auth/background/file/:name`.
  - Удаление через `DELETE /api/system/auth/background`.
- **Discord-интеграция**:
  - Включение/отключение и настройка параметров (`client_id`, `client_secret`, `redirect_uri`) через UI (раздел "Настройки", `key: settings`) или API.
  - Управление scopes через `GET/POST/DELETE /api/discord/scopes`.
  - Управление маппингами через `GET/POST/DELETE /api/discord/scope-mappings`.
- **Пользовательские настройки**:
  - Сохранение темы (`light` или `dark`) через `PUT /api/user/theme`.
  - Сохранение макетов страниц через `PUT /api/user/layouts/:page`.
- **Health Check**:
  - Проверка доступности через `GET /health` (возвращает `{ "status": "ok" }`).

### 7.3 Бизнес-процессы
1. **Настройка фона**:
   - Администратор загружает изображение через UI или API, оно сохраняется в `backend/data` и становится доступным публично.
2. **Настройка Discord**:
   - Администратор включает интеграцию, задает параметры и маппинги через UI (раздел "Настройки") или API.
   - Система валидирует `client_id` и `redirect_uri` перед активацией.
3. **Персонализация**:
   - Пользователь выбирает тему или сохраняет макеты через UI (раздел "Профиль") или API.
4. **Мониторинг**:
   - Система проверяет доступность через `GET /health`, используемое оркестраторами и фронтендом.

### 7.4 Бизнес-правила
- Фоновое изображение ограничено размером (25 МБ, настраивается в `nginx.conf`).
- Discord-настройки требуют валидных `client_id` и `redirect_uri` для работы OAuth.
- Изменения системных настроек требуют права `settings:write`.
- Пользовательские настройки (тема, макеты) доступны всем аутентифицированным пользователям.

### 7.5 Технические детали
- **Таблицы**: `settings`, `discord_settings`, `discord_scopes`, `discord_scope_mappings`, `user_layouts`.
- **API**: `/public/auth/background`, `/api/system/auth/background`, `/api/user/theme`, `/api/user/layouts/:page`, `/api/discord/scopes`, `/api/discord/scope-mappings`, `/health`.
- **UI**: Раздел "Настройки" (`key: settings`) для системных параметров, "Профиль" (`key: profile`) для пользовательских настроек.
- **Права доступа**: `settings:read` для просмотра, `settings:write` для модификаций.

---

## 8. Аутентификация и Навигация

### 8.1 Аутентификация
- **Локальный вход**:
  - Форма на странице входа (`POST /auth/login`) принимает имя пользователя и пароль.
- **Discord OAuth**:
  - Кнопка "Войти через Discord" инициирует редирект через `GET /auth/discord`.
  - После авторизации в Discord пользователь перенаправляется на `/auth/discord/callback`, получая JWT через `?token=...`.
- **Профиль**:
  - После входа `GET /auth/profile` возвращает данные пользователя и разрешения, отображаемые в разделе "Профиль" (`key: profile`).
- **Публичные ресурсы**:
  - `GET /health`, `GET /public/auth/background`, `GET /public/auth/background/file/:name`, `GET /public/discord-enabled` доступны без аутентификации.

### 8.2 Навигация
- **Страница входа**: Содержит форму локального входа и кнопку Discord OAuth.
- **Главное приложение**:
  - После входа пользователь попадает в `MainLayout` с боковым меню, где разделы выбираются через `selectedKey` (без отдельных URL-маршрутов).
  - Разделы: Финансы (`finance`), Склад (`warehouse`), Витрина (`showcase`), Заявки (`requests`, только для администраторов), Пользователи (`users`), Справочники (`directories`), Настройки (`settings`).
  - Меню пользователя в шапке: Профиль (`profile`), Корзина (`cart`), Выход.
- **Роутинг**: Используется `BrowserRouter`, но навигация по разделам реализована через состояние `selectedKey`. Возможна доработка с явными маршрутами (например, `/finance`).

### 8.3 Бизнес-правила
- Доступ к разделам определяется правами (`permissions`) из профиля пользователя.
- Раздел "Заявки" виден только пользователям с правом `users:write`.
- Публичные ресурсы доступны для неаутентифицированных пользователей.

---

## 9. Безопасность и Инфраструктура

### 9.1 Безопасность
- **Аутентификация**: JWT с криптостойким секретом (`JWT_SECRET`) и сроком действия (`TOKEN_EXPIRY`, по умолчанию 24 часа).
- **Авторизация**: Middleware `requirePermission` проверяет права (`none`, `read`, `write`) для каждого ресурса.
- **HTTPS**: Настраивается через Nginx с сертификатами в `./ssl`.
- **Ограничения доступа**:
  - Сетевые ACL для PostgreSQL.
  - Валидация входных данных через серверную логику.
  - Защита от пустых значений в настройках Discord (`PUT /api/system/discord`).
- **Логирование**: Действия по заявкам и настройкам фиксируются для аудита.

### 9.2 Инфраструктура
- **Развертывание**: Docker Compose с контейнерами:
  - `app`: Node.js-приложение (порт 3000).
  - `postgres`: PostgreSQL (порт 5433 на хосте).
  - `nginx`: Reverse proxy (порты 80/443).
 - **Публикация**: приложение доступно по адресу `https://korjeek.ru/economy/` (Nginx проксирует под поддиректорией `/economy` на `app:3000`). Публичный URL: `https://korjeek.ru/economy/`.
- **Переменные окружения**:
  - `backend/.env`: Секреты (`JWT_SECRET`, Discord OAuth), порты, URL.
  - `frontend/.env`: Параметры фронтенда (без секретов).
   - В продакшене `FRONTEND_URL=https://korjeek.ru/economy`.
- **Миграции**: Применяются автоматически через `backend/migrations/*.sql`.
- **Резервное копирование**:
  - Том `pgdata` для БД (бэкап через `pg_dump` или `pg_basebackup`).
  - Папка `backend/data` для файлов (например, фоновое изображение).

### 9.3 Мониторинг
- Эндпоинт `GET /health` используется для проверки состояния сервера и БД.
- Логи запросов фиксируют `req.body` после парсинга (`express.json()`).

---

## 10. Заключение

Система BLSK Star Finance предоставляет комплексное решение для управления финансами, складом, витриной, заявками, пользователями, справочниками и настройками. Каждый модуль интегрирован через REST API, поддерживает ролевую модель доступа и отображается в удобном UI с боковым меню. Интеграция с Discord OAuth и поддержка персонализации (темы, макеты) обеспечивают гибкость и удобство. Для детальной информации по API, схеме данных и развертыванию рекомендуется обратиться к файлам `api-spec.md`, `db-schema.md`, `deploy.md` и `sitemap.md`.